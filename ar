-- Services
local Players           = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService        = game:GetService("RunService")
local UIS               = game:GetService("UserInputService")
local InsertService     = game:GetService("InsertService")

-- Player refs
local player            = Players.LocalPlayer
local character         = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart  = character:WaitForChild("HumanoidRootPart")

-- Load Dear ReGui
local ReGui = loadstring(game:HttpGet(
    'https://raw.githubusercontent.com/depthso/Dear-ReGui/refs/heads/main/ReGui.lua'
))()
local PrefabsId = "rbxassetid://" .. ReGui.PrefabsId
ReGui:Init({
    Prefabs = InsertService:LoadLocalAsset(PrefabsId)
})

-- Global state
_G.AutoDodge      = false
_G.AutoQTE        = false
_G.AutoThorian    = false
_G.SelectedWeapon = "Sword"

local autoDodgeTask, autoQteTask, autoThorianTask

--=== CORE LOOPS ===--

local function startAutoDodge()
    while _G.AutoDodge do
        pcall(function()
            local remotes = ReplicatedStorage:FindFirstChild("Remotes")
            local info    = remotes and remotes:FindFirstChild("Information")
            local rf      = info    and info:FindFirstChild("RemoteFunction")
            if rf then
                rf:FireServer({true, true}, "DodgeMinigame")
            end
        end)
        task.wait(0.2)
    end
end

local function startAutoQTE()
    while _G.AutoQTE do
        pcall(function()
            local remotes = ReplicatedStorage:FindFirstChild("Remotes")
            local info    = remotes and remotes:FindFirstChild("Information")
            local rf      = info    and info:FindFirstChild("RemoteFunction")
            if rf then
                rf:FireServer(true, _G.SelectedWeapon .. "QTE")
            end
        end)
        task.wait(0.4)
    end
end

local function startAutoThorianQTE()
    while _G.AutoThorian do
        pcall(function()
            local remotes = ReplicatedStorage:FindFirstChild("Remotes")
            local info    = remotes and remotes:FindFirstChild("Information")
            local rf      = info    and info:FindFirstChild("RemoteFunction")
            if rf then
                rf:FireServer(true, "ThorianQTE")
            end
        end)
        task.wait(0.4)
    end
end

--=== BUILD THE WINDOW ===--

local Window = ReGui:TabsWindow({
    Title = "AutoSystem & Teleport",
    Size  = UDim2.fromOffset(360, 520),
})

-- Tab 1: 메인
local mainTab = Window:CreateTab({Name = "메인"})
mainTab:Label({Text = "이곳엔 메인 기능들이 있습니다다!"})

-- 자동회피 토글
mainTab:Button({
    Text     = "자동회피: OFF",
    TextSize = 18,
    Callback = function(self)
        _G.AutoDodge = not _G.AutoDodge
        self:SetText("자동회피: " .. (_G.AutoDodge and "ON" or "OFF"))
        if _G.AutoDodge then
            autoDodgeTask = task.spawn(startAutoDodge)
        else
            autoDodgeTask = nil
        end
    end,
})

-- 무기 QTE 토글
mainTab:Button({
    Text     = "무기 QTE: OFF",
    TextSize = 18,
    Callback = function(self)
        _G.AutoQTE = not _G.AutoQTE
        self:SetText("무기 QTE: " .. (_G.AutoQTE and "ON" or "OFF"))
        if _G.AutoQTE then
            autoQteTask = task.spawn(startAutoQTE)
        else
            autoQteTask = nil
        end
    end,
})

-- 토리안 QTE 토글
mainTab:Button({
    Text     = "토리안 QTE: OFF",
    TextSize = 18,
    Callback = function(self)
        _G.AutoThorian = not _G.AutoThorian
        self:SetText("토리안 QTE: " .. (_G.AutoThorian and "ON" or "OFF"))
        if _G.AutoThorian then
            autoThorianTask = task.spawn(startAutoThorianQTE)
        else
            autoThorianTask = nil
        end
    end,
})

-- 무기 선택
mainTab:Label({Text = "무기 선택:"})
local weapons = {"Sword","Spear","Magic","Dagger","Fist"}
for _, w in ipairs(weapons) do
    mainTab:Button({
        Text     = w,
        TextSize = 14,
        Callback = function()
            _G.SelectedWeapon = w
            warn("Selected weapon:", w)
        end,
    })
end

-- Global keybind to toggle window
UIS.InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == Enum.KeyCode.K then
        Window:ToggleVisibility()
    end
end)
-- 이어서 같은 스코프에서 실행된다고 가정합니다.

-- Tab 2: NPC 이동
local npcTab = Window:CreateTab({Name = "NPC 이동"})
npcTab:Label({Text = "🧭 NPC 빠른이동"})

-- NPC 다시 불러오기 버튼
local reloadBtn = npcTab:Button({Text = "🔄 NPC 다시 불러오기"})

-- 스크롤 캔버스
local scrollCanvas = npcTab:ScrollingCanvas({
    Fill      = true,
    UiPadding = UDim.new(0,4),
})

-- 텔레포트 버튼
local tpBtn = npcTab:Button({
    Text     = "🚀 선택한 NPC로 이동",
    TextSize = 16,
})

-- NPC 로드 함수
local function loadNPCs()
    selectedNPC = nil
    -- 클리어
    for _, child in ipairs(scrollCanvas.Frame:GetChildren()) do
        if child:IsA("GuiObject") then
            child:Destroy()
        end
    end

    -- NPC 스캔
    for _, obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("Model")
        and obj:FindFirstChild("Humanoid")
        and obj:FindFirstChild("HumanoidRootPart") then

            local btn = scrollCanvas:Button({
                Text     = obj.Name,
                TextSize = 14,
            })
            btn.MouseButton1Click:Connect(function()
                selectedNPC = obj
                -- 하이라이트
                for _, sib in ipairs(scrollCanvas.Frame:GetChildren()) do
                    if sib:IsA("TextButton") then
                        sib.BackgroundColor3 = Color3.fromRGB(90,90,90)
                    end
                end
                btn.BackgroundColor3 = Color3.fromRGB(0,170,255)
            end)
        end
    end
end

-- 버튼 연결
reloadBtn.MouseButton1Click:Connect(loadNPCs)
tpBtn.MouseButton1Click:Connect(function()
    if selectedNPC then
        fastTeleportTo(selectedNPC)
    else
        tpBtn:SetText("❗ NPC 선택하세요")
        task.delay(1, function()
            tpBtn:SetText("🚀 선택한 NPC로 이동")
        end)
    end
end)

-- 초기 로드
loadNPCs()
