-- 통합 GUI: 자동회피, 무기 QTE, 토리안 QTE, 무기 선택, NPC 텔레포트

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- 상태 변수
_G.AutoDodge = false
_G.AutoQTE = false
_G.AutoThorian = false
_G.SelectedWeapon = "Sword"

local autoDodgeTask = nil
local autoQteTask = nil
local autoThorianTask = nil

-- GUI 생성
local gui = Instance.new("ScreenGui")
gui.Name = "AutoSystemUI"
gui.ResetOnSpawn = false
gui.Parent = playerGui

-- 프레임
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 330, 0, 400)
frame.Position = UDim2.new(0.7, -150, 0.5, -200)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = gui

-- 탭 생성
local tabButtons = {}
local tabs = {}
local tabNames = {"자동", "무기선택", "텔레포트"}

local tabBar = Instance.new("Frame", frame)
tabBar.Size = UDim2.new(1, 0, 0, 30)
tabBar.BackgroundColor3 = Color3.fromRGB(60, 60, 60)

for i, name in ipairs(tabNames) do
    local tabBtn = Instance.new("TextButton", tabBar)
    tabBtn.Size = UDim2.new(0, 100, 1, 0)
    tabBtn.Position = UDim2.new(0, (i - 1) * 110, 0, 0)
    tabBtn.Text = name
    tabBtn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
    tabBtn.TextColor3 = Color3.new(1, 1, 1)
    tabBtn.Font = Enum.Font.SourceSansBold
    tabBtn.TextSize = 14
    tabButtons[name] = tabBtn
end

-- 탭 컨테이너
for _, name in ipairs(tabNames) do
    local tab = Instance.new("Frame", frame)
    tab.Size = UDim2.new(1, 0, 1, -30)
    tab.Position = UDim2.new(0, 0, 0, 30)
    tab.BackgroundTransparency = 1
    tab.Visible = false
    tabs[name] = tab
end

-- 탭 전환 함수
local function switchTab(tabName)
    for name, tab in pairs(tabs) do
        tab.Visible = (name == tabName)
    end
end

for name, btn in pairs(tabButtons) do
    btn.MouseButton1Click:Connect(function()
        switchTab(name)
    end)
end
switchTab("자동")

-- 자동 탭
local autoTab = tabs["자동"]
local function createAutoButton(text, posY, toggleVar, toggleFunc)
    local btn = Instance.new("TextButton", autoTab)
    btn.Size = UDim2.new(1, -20, 0, 40)
    btn.Position = UDim2.new(0, 10, 0, posY)
    btn.Text = text .. ": OFF"
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 18
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.BackgroundColor3 = Color3.fromRGB(70, 130, 180)
    btn.MouseButton1Click:Connect(function()
        _G[toggleVar] = not _G[toggleVar]
        btn.Text = text .. ": " .. (_G[toggleVar] and "ON" or "OFF")
        if _G[toggleVar] then
            if not _G[toggleFunc] then
                _G[toggleFunc] = task.spawn(_G["start" .. toggleFunc])
            end
        else
            _G[toggleFunc] = nil
        end
    end)
end

createAutoButton("자동회피", 10, "AutoDodge", "autoDodgeTask")
createAutoButton("무기 QTE", 60, "AutoQTE", "autoQteTask")
createAutoButton("토리안 QTE", 110, "AutoThorian", "autoThorianTask")

function _G.startautoDodgeTask()
    while _G.AutoDodge do
        pcall(function()
            local rf = ReplicatedStorage:FindFirstChild("Remotes")
                and ReplicatedStorage.Remotes:FindFirstChild("Information")
                and ReplicatedStorage.Remotes.Information:FindFirstChild("RemoteFunction")
            if rf then rf:FireServer({true, true}, "DodgeMinigame") end
        end)
        task.wait(0.2)
    end
end

function _G.startautoQteTask()
    while _G.AutoQTE do
        pcall(function()
            local rf = ReplicatedStorage:FindFirstChild("Remotes")
                and ReplicatedStorage.Remotes:FindFirstChild("Information")
                and ReplicatedStorage.Remotes.Information:FindFirstChild("RemoteFunction")
            if rf then rf:FireServer(true, _G.SelectedWeapon .. "QTE") end
        end)
        task.wait(0.4)
    end
end

function _G.startautoThorianTask()
    while _G.AutoThorian do
        pcall(function()
            local rf = ReplicatedStorage:FindFirstChild("Remotes")
                and ReplicatedStorage.Remotes:FindFirstChild("Information")
                and ReplicatedStorage.Remotes.Information:FindFirstChild("RemoteFunction")
            if rf then rf:FireServer(true, "ThorianQTE") end
        end)
        task.wait(0.4)
    end
end

-- 무기 선택 탭
local weaponTab = tabs["무기선택"]
local weapons = {"Sword", "Spear", "Magic", "Dagger", "Fist"}

for i, weapon in ipairs(weapons) do
    local btn = Instance.new("TextButton", weaponTab)
    btn.Size = UDim2.new(0, 130, 0, 30)
    btn.Position = UDim2.new(0, 10 + ((i - 1) % 2) * 140, 0, 10 + math.floor((i - 1) / 2) * 40)
    btn.Text = weapon
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 16
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
    btn.MouseButton1Click:Connect(function()
        _G.SelectedWeapon = weapon
        print("선택된 무기:", weapon)
    end)
end

-- 텔레포트 탭
local teleportTab = tabs["텔레포트"]
local scrollFrame = Instance.new("ScrollingFrame", teleportTab)
scrollFrame.Size = UDim2.new(1, -20, 1, -80)
scrollFrame.Position = UDim2.new(0, 10, 0, 10)
scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
scrollFrame.ScrollBarThickness = 8
scrollFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
scrollFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)

local UIList = Instance.new("UIListLayout", scrollFrame)
UIList.Padding = UDim.new(0, 5)
UIList.SortOrder = Enum.SortOrder.LayoutOrder

local npcButtons = {}
local selectedNPC = nil

local function loadNPCs()
    for _, btn in pairs(npcButtons) do btn:Destroy() end
    npcButtons = {}
    selectedNPC = nil

    for _, obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("Model") and obj:FindFirstChild("Humanoid") and obj:FindFirstChild("HumanoidRootPart") then
            local btn = Instance.new("TextButton")
            btn.Size = UDim2.new(1, 0, 0, 25)
            btn.Text = obj.Name
            btn.Font = Enum.Font.SourceSans
            btn.TextSize = 14
            btn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
            btn.TextColor3 = Color3.new(1, 1, 1)
            btn.MouseButton1Click:Connect(function()
                selectedNPC = obj
                for _, b in ipairs(npcButtons) do b.BackgroundColor3 = Color3.fromRGB(90, 90, 90) end
                btn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
            end)
            btn.Parent = scrollFrame
            table.insert(npcButtons, btn)
        end
    end
end

local function fastTeleportTo(target)
    if not target or not target:FindFirstChild("HumanoidRootPart") then return end
    local speed = 200
    local targetPos = target.HumanoidRootPart.Position
    local direction = (targetPos - humanoidRootPart.Position).Unit
    local distance = (targetPos - humanoidRootPart.Position).Magnitude
    local duration = distance / speed

    for _, part in ipairs(character:GetDescendants()) do
        if part:IsA("BasePart") then part.CanCollide = false end
    end

    local startTime = tick()
    local connection
    connection = RunService.Heartbeat:Connect(function()
        local elapsed = tick() - startTime
        if elapsed >= duration then
            humanoidRootPart.CFrame = CFrame.new(targetPos)
            connection:Disconnect()
            return
        end
        humanoidRootPart.CFrame = humanoidRootPart.CFrame + direction * speed * RunService.Heartbeat:Wait()
    end)
end

local reloadBtn = Instance.new("TextButton", teleportTab)
reloadBtn.Size = UDim2.new(0.5, -15, 0, 30)
reloadBtn.Position = UDim2.new(0, 10, 1, -40)
reloadBtn.Text = "🔄 다시 불러오기"
reloadBtn.Font = Enum.Font.SourceSansBold
reloadBtn.TextSize = 14
reloadBtn.TextColor3 = Color3.new(1, 1, 1)
reloadBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
reloadBtn.MouseButton1Click:Connect(loadNPCs)

local tpBtn = Instance.new("TextButton", teleportTab)
tpBtn.Size = UDim2.new(0.5, -15, 0, 30)
tpBtn.Position = UDim2.new(0.5, 5, 1, -40)
tpBtn.Text = "🚀 이동"
tpBtn.Font = Enum.Font.SourceSansBold
