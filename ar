-- Services
local Players           = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService        = game:GetService("RunService")
local UIS               = game:GetService("UserInputService")
local InsertService     = game:GetService("InsertService")

-- Player refs
local player            = Players.LocalPlayer
local character         = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart  = character:WaitForChild("HumanoidRootPart")

-- Load DearÂ ReGui
local ReGui = loadstring(game:HttpGet(
    'https://raw.githubusercontent.com/depthso/Dear-ReGui/refs/heads/main/ReGui.lua'
))()
local PrefabsId = "rbxassetid://" .. ReGui.PrefabsId
ReGui:Init({
    Prefabs = InsertService:LoadLocalAsset(PrefabsId)
})

-- Global state
_G.AutoDodge      = false
_G.AutoQTE        = false
_G.AutoThorian    = false
_G.SelectedWeapon = "Sword"

local autoDodgeTask, autoQteTask, autoThorianTask

--=== CORE LOOPS ===--

local function startAutoDodge()
    while _G.AutoDodge do
        pcall(function()
            local remotes = ReplicatedStorage:FindFirstChild("Remotes")
            local info    = remotes and remotes:FindFirstChild("Information")
            local rf      = info    and info:FindFirstChild("RemoteFunction")
            if rf then
                rf:FireServer({true, true}, "DodgeMinigame")
            end
        end)
        task.wait(0.2)
    end
end

local function startAutoQTE()
    while _G.AutoQTE do
        pcall(function()
            local remotes = ReplicatedStorage:FindFirstChild("Remotes")
            local info    = remotes and remotes:FindFirstChild("Information")
            local rf      = info    and info:FindFirstChild("RemoteFunction")
            if rf then
                rf:FireServer(true, _G.SelectedWeapon .. "QTE")
            end
        end)
        task.wait(0.4)
    end
end

local function startAutoThorianQTE()
    while _G.AutoThorian do
        pcall(function()
            local remotes = ReplicatedStorage:FindFirstChild("Remotes")
            local info    = remotes and remotes:FindFirstChild("Information")
            local rf      = info    and info:FindFirstChild("RemoteFunction")
            if rf then
                rf:FireServer(true, "ThorianQTE")
            end
        end)
        task.wait(0.4)
    end
end

--=== BUILD THE WINDOW ===--

local Window = ReGui:TabsWindow({
    Title = "AutoSystem & Teleport",
    Size  = UDim2.fromOffset(360, 520),
})

-- Tab 1: ë©”ì¸
local mainTab = Window:CreateTab({Name = "ë©”ì¸"})
mainTab:Label({Text = "ì´ê³³ì—” ë©”ì¸ ê¸°ëŠ¥ë“¤ì´ ìˆìŠµë‹ˆë‹¤ë‹¤!"})

-- ìë™íšŒí”¼ í† ê¸€
mainTab:Button({
    Text     = "ìë™íšŒí”¼: OFF",
    TextSize = 18,
    Callback = function(self)
        _G.AutoDodge = not _G.AutoDodge
        self:SetText("ìë™íšŒí”¼: " .. (_G.AutoDodge and "ON" or "OFF"))
        if _G.AutoDodge then
            autoDodgeTask = task.spawn(startAutoDodge)
        else
            autoDodgeTask = nil
        end
    end,
})

-- ë¬´ê¸° QTE í† ê¸€
mainTab:Button({
    Text     = "ë¬´ê¸° QTE: OFF",
    TextSize = 18,
    Callback = function(self)
        _G.AutoQTE = not _G.AutoQTE
        self:SetText("ë¬´ê¸° QTE: " .. (_G.AutoQTE and "ON" or "OFF"))
        if _G.AutoQTE then
            autoQteTask = task.spawn(startAutoQTE)
        else
            autoQteTask = nil
        end
    end,
})

-- í† ë¦¬ì•ˆ QTE í† ê¸€
mainTab:Button({
    Text     = "í† ë¦¬ì•ˆ QTE: OFF",
    TextSize = 18,
    Callback = function(self)
        _G.AutoThorian = not _G.AutoThorian
        self:SetText("í† ë¦¬ì•ˆ QTE: " .. (_G.AutoThorian and "ON" or "OFF"))
        if _G.AutoThorian then
            autoThorianTask = task.spawn(startAutoThorianQTE)
        else
            autoThorianTask = nil
        end
    end,
})

-- ë¬´ê¸° ì„ íƒ
mainTab:Label({Text = "ë¬´ê¸° ì„ íƒ:"})
local weapons = {"Sword","Spear","Magic","Dagger","Fist"}
for _, w in ipairs(weapons) do
    mainTab:Button({
        Text     = w,
        TextSize = 14,
        Callback = function()
            _G.SelectedWeapon = w
            warn("Selected weapon:", w)
        end,
    })
end

-- Global keybind to toggle window
UIS.InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == Enum.KeyCode.K then
        Window:ToggleVisibility()
    end
end)
-- ì´ì–´ì„œ ê°™ì€ ìŠ¤ì½”í”„ì—ì„œ ì‹¤í–‰ëœë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.

-- Tab 2: NPC ì´ë™
local npcTab = Window:CreateTab({Name = "NPC ì´ë™"})
npcTab:Label({Text = "ğŸ§­ NPC ë¹ ë¥¸ì´ë™"})

-- NPC ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼
local reloadBtn = npcTab:Button({Text = "ğŸ”„ NPC ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°"})

-- ìŠ¤í¬ë¡¤ ìº”ë²„ìŠ¤
local scrollCanvas = npcTab:ScrollingCanvas({
    Fill      = true,
    UiPadding = UDim.new(0,4),
})

-- í…”ë ˆí¬íŠ¸ ë²„íŠ¼
local tpBtn = npcTab:Button({
    Text     = "ğŸš€ ì„ íƒí•œ NPCë¡œ ì´ë™",
    TextSize = 16,
})

-- NPC ë¡œë“œ í•¨ìˆ˜
local function loadNPCs()
    selectedNPC = nil
    -- í´ë¦¬ì–´
    for _, child in ipairs(scrollCanvas.Frame:GetChildren()) do
        if child:IsA("GuiObject") then
            child:Destroy()
        end
    end

    -- NPC ìŠ¤ìº”
    for _, obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("Model")
        and obj:FindFirstChild("Humanoid")
        and obj:FindFirstChild("HumanoidRootPart") then

            local btn = scrollCanvas:Button({
                Text     = obj.Name,
                TextSize = 14,
            })
            btn.MouseButton1Click:Connect(function()
                selectedNPC = obj
                -- í•˜ì´ë¼ì´íŠ¸
                for _, sib in ipairs(scrollCanvas.Frame:GetChildren()) do
                    if sib:IsA("TextButton") then
                        sib.BackgroundColor3 = Color3.fromRGB(90,90,90)
                    end
                end
                btn.BackgroundColor3 = Color3.fromRGB(0,170,255)
            end)
        end
    end
end

-- ë²„íŠ¼ ì—°ê²°
reloadBtn.MouseButton1Click:Connect(loadNPCs)
tpBtn.MouseButton1Click:Connect(function()
    if selectedNPC then
        fastTeleportTo(selectedNPC)
    else
        tpBtn:SetText("â— NPC ì„ íƒí•˜ì„¸ìš”")
        task.delay(1, function()
            tpBtn:SetText("ğŸš€ ì„ íƒí•œ NPCë¡œ ì´ë™")
        end)
    end
end)

-- ì´ˆê¸° ë¡œë“œ
loadNPCs()
