-- Services
local Players           = game:GetService("Players")
local Workspace         = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService        = game:GetService("RunService")
local UIS               = game:GetService("UserInputService")
local InsertService     = game:GetService("InsertService")

-- Player refs
local player            = Players.LocalPlayer
local character         = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart  = character:WaitForChild("HumanoidRootPart")

-- Load DearÂ ReGui
local ReGui = loadstring(game:HttpGet(
    'https://raw.githubusercontent.com/depthso/Dear-ReGui/refs/heads/main/ReGui.lua'
))()
local PrefabsId = "rbxassetid://" .. ReGui.PrefabsId
ReGui:Init({
    Prefabs = InsertService:LoadLocalAsset(PrefabsId)
})

-- Global state
_G.AutoDodge      = false
_G.AutoQTE        = false
_G.AutoThorian    = false
_G.SelectedWeapon = "Sword"

local autoDodgeTask, autoQteTask, autoThorianTask
local selectedNPC
local npcButtons = {}

--=== CORE LOOPS & FUNCTIONS ===--

local function startAutoDodge()
    while _G.AutoDodge do
        pcall(function()
            local remotes = ReplicatedStorage:FindFirstChild("Remotes")
            local info    = remotes and remotes:FindFirstChild("Information")
            local rf      = info    and info:FindFirstChild("RemoteFunction")
            if rf then
                rf:FireServer({true, true}, "DodgeMinigame")
            end
        end)
        task.wait(0.2)
    end
end

local function startAutoQTE()
    while _G.AutoQTE do
        pcall(function()
            local remotes = ReplicatedStorage:FindFirstChild("Remotes")
            local info    = remotes and remotes:FindFirstChild("Information")
            local rf      = info    and info:FindFirstChild("RemoteFunction")
            if rf then
                local name = _G.SelectedWeapon .. "QTE"
                rf:FireServer(true, name)
            end
        end)
        task.wait(0.4)
    end
end

local function startAutoThorianQTE()
    while _G.AutoThorian do
        pcall(function()
            local remotes = ReplicatedStorage:FindFirstChild("Remotes")
            local info    = remotes and remotes:FindFirstChild("Information")
            local rf      = info    and info:FindFirstChild("RemoteFunction")
            if rf then
                rf:FireServer(true, "ThorianQTE")
            end
        end)
        task.wait(0.4)
    end
end

local function fastTeleportTo(target)
    if not (target and target:FindFirstChild("HumanoidRootPart")) then return end

    -- collision off
    for _, p in ipairs(character:GetDescendants()) do
        if p:IsA("BasePart") then p.CanCollide = false end
    end

    local speed     = 200
    local startPos  = humanoidRootPart.Position
    local endPos    = target.HumanoidRootPart.Position
    local dir       = (endPos - startPos).Unit
    local dist      = (endPos - startPos).Magnitude
    local duration  = dist / speed
    local t0        = tick()

    local conn
    conn = RunService.Heartbeat:Connect(function(dt)
        local elapsed = tick() - t0
        if elapsed >= duration then
            humanoidRootPart.CFrame = CFrame.new(endPos)
            conn:Disconnect()
        else
            humanoidRootPart.CFrame = humanoidRootPart.CFrame + dir * speed * dt
        end
    end)
end

--=== BUILD REGUI WINDOW ===--

local Window = ReGui:TabsWindow({
    Title = "AutoSystem & Teleport",
    Size  = UDim2.fromOffset(360, 520),
})

--â€“â€“â€“â€“â€“ Tab 1: ë©”ì¸ â€“â€“â€“â€“â€“--
local mainTab = Window:CreateTab({Name = "ë©”ì¸"})
mainTab:Label({Text = "ì´ê³³ì—” ë©”ì¸ ê¸°ëŠ¥ë“¤ì´ ìˆìŠµë‹ˆë‹¤ë‹¤!"})

-- ìë™íšŒí”¼ í† ê¸€
mainTab:Button({
    Text     = "ìë™íšŒí”¼: OFF",
    TextSize = 18,
    Callback = function(self)
        _G.AutoDodge = not _G.AutoDodge
        self:SetText("ìë™íšŒí”¼: " .. (_G.AutoDodge and "ON" or "OFF"))
        if _G.AutoDodge then
            autoDodgeTask = task.spawn(startAutoDodge)
        else
            autoDodgeTask = nil
        end
    end,
})

-- ë¬´ê¸° QTE í† ê¸€
mainTab:Button({
    Text     = "ë¬´ê¸° QTE: OFF",
    TextSize = 18,
    Callback = function(self)
        _G.AutoQTE = not _G.AutoQTE
        self:SetText("ë¬´ê¸° QTE: " .. (_G.AutoQTE and "ON" or "OFF"))
        if _G.AutoQTE then
            autoQteTask = task.spawn(startAutoQTE)
        else
            autoQteTask = nil
        end
    end,
})

-- í† ë¦¬ì•ˆ QTE í† ê¸€
mainTab:Button({
    Text     = "í† ë¦¬ì•ˆ QTE: OFF",
    TextSize = 18,
    Callback = function(self)
        _G.AutoThorian = not _G.AutoThorian
        self:SetText("í† ë¦¬ì•ˆ QTE: " .. (_G.AutoThorian and "ON" or "OFF"))
        if _G.AutoThorian then
            autoThorianTask = task.spawn(startAutoThorianQTE)
        else
            autoThorianTask = nil
        end
    end,
})

-- ë¬´ê¸° ì„ íƒ
mainTab:Label({Text = "ë¬´ê¸° ì„ íƒ:"})
local weapons = {"Sword","Spear","Magic","Dagger","Fist"}
for _, w in ipairs(weapons) do
    mainTab:Button({
        Text     = w,
        TextSize = 14,
        Callback = function()
            _G.SelectedWeapon = w
            warn("Selected weapon:", w)
        end,
    })
end

--â€“â€“â€“â€“â€“ Tab 2: NPC ì´ë™ â€“â€“â€“â€“â€“--
local npcTab = Window:CreateTab({Name = "NPC ì´ë™"})
npcTab:Label({Text = "ğŸ§­ NPC ë¹ ë¥¸ì´ë™"})

-- NPC ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
local reloadBtn = npcTab:Button({Text = "ğŸ”„ NPC ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°"})

-- ìŠ¤í¬ë¡¤ ìº”ë²„ìŠ¤
local scrollCanvas = npcTab:ScrollingCanvas({
    Fill      = true,
    UiPadding = UDim.new(0,4),
})

-- ì´ë™ ë²„íŠ¼
local tpBtn = npcTab:Button({
    Text     = "ğŸš€ ì„ íƒí•œ NPCë¡œ ì´ë™",
    TextSize = 16,
})

-- NPC ë¡œë“œ í•¨ìˆ˜
local function loadNPCs()
    selectedNPC = nil
    -- clear
    for _, c in ipairs(scrollCanvas.Frame:GetChildren()) do
        if c:IsA("GuiObject") then c:Destroy() end
    end

    -- scan
    for _, obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("Model")
        and obj:FindFirstChild("Humanoid")
        and obj:FindFirstChild("HumanoidRootPart") then

            local btn = scrollCanvas:Button({
                Text     = obj.Name,
                TextSize = 14,
            })
            btn.MouseButton1Click:Connect(function()
                selectedNPC = obj
                -- highlight
                for _, sib in ipairs(scrollCanvas.Frame:GetChildren()) do
                    if sib:IsA("TextButton") then
                        sib.BackgroundColor3 = Color3.fromRGB(90,90,90)
                    end
                end
                btn.BackgroundColor3 = Color3.fromRGB(0,170,255)
            end)
        end
    end
end

reloadBtn.MouseButton1Click:Connect(loadNPCs)
tpBtn.MouseButton1Click:Connect(function()
    if selectedNPC then
        fastTeleportTo(selectedNPC)
    else
        tpBtn:SetText("â— NPC ì„ íƒí•˜ì„¸ìš”")
        task.delay(1, function()
            tpBtn:SetText("ğŸš€ ì„ íƒí•œ NPCë¡œ ì´ë™")
        end)
    end
end)

-- ìµœì´ˆ ë¡œë“œ
loadNPCs()

-- K í‚¤ë¡œ í† ê¸€
UIS.InputBegan:Connect(function(i, proc)
    if not proc and i.KeyCode == Enum.KeyCode.K then
        Window:ToggleVisibility()
    end
end)
