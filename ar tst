local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ScreenGui 생성
local gui = Instance.new("ScreenGui")
gui.Name = "AutoDodgeUI"
gui.ResetOnSpawn = false
gui.Parent = playerGui

-- 프레임
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 200, 0, 80)
frame.Position = UDim2.new(0.5, -100, 0.5, -40)
frame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
frame.Parent = gui

-- 자동회피 버튼
local autoDodgeButton = Instance.new("TextButton", frame)
autoDodgeButton.Size = UDim2.new(1, -20, 0, 40)
autoDodgeButton.Position = UDim2.new(0, 10, 0, 20)
autoDodgeButton.Text = "자동회피: OFF"
autoDodgeButton.Font = Enum.Font.SourceSansBold
autoDodgeButton.TextSize = 18
autoDodgeButton.TextColor3 = Color3.new(1, 1, 1)
autoDodgeButton.BackgroundColor3 = Color3.fromRGB(70, 130, 180)

-- 무기 선택 버튼
local weaponButton = Instance.new("TextButton", frame)
weaponButton.Size = UDim2.new(1, -20, 0, 40)
weaponButton.Position = UDim2.new(0, 10, 0, 60)
weaponButton.Text = "무기 선택"
weaponButton.Font = Enum.Font.SourceSansBold
weaponButton.TextSize = 18
weaponButton.TextColor3 = Color3.new(1, 1, 1)
weaponButton.BackgroundColor3 = Color3.fromRGB(70, 130, 180)

-- 무기 목록
local weapons = {"Spear", "Magic", "Dagger", "Fist", "Sword"}
local selectedWeapon = "Sword" -- 기본값

-- 자동회피 변수
_G.AutoDodge = false
local autoDodgeTask = nil

-- 자동회피 루프
local function startAutoDodge()
    while _G.AutoDodge do
        pcall(function()
            local remotes = ReplicatedStorage:FindFirstChild("Remotes")
            if remotes then
                local info = remotes:FindFirstChild("Information")
                local rf = info and info:FindFirstChild("RemoteFunction")
                if rf then
                    rf:FireServer({true, true}, "DodgeMinigame")
                end
            end
        end)
        wait(0.2)
    end
end

-- 자동회피 버튼 클릭 핸들러
autoDodgeButton.MouseButton1Click:Connect(function()
    _G.AutoDodge = not _G.AutoDodge
    autoDodgeButton.Text = "자동회피: " .. (_G.AutoDodge and "ON" or "OFF")
    
    if _G.AutoDodge then
        if not autoDodgeTask then
            autoDodgeTask = task.spawn(startAutoDodge)
        end
    else
        autoDodgeTask = nil
    end
end)

-- 무기 선택 버튼 클릭 핸들러
weaponButton.MouseButton1Click:Connect(function()
    local weaponGui = Instance.new("ScreenGui")
    weaponGui.Name = "WeaponSelectUI"
    weaponGui.Parent = playerGui

    local weaponFrame = Instance.new("Frame")
    weaponFrame.Size = UDim2.new(0, 200, 0, 240)
    weaponFrame.Position = UDim2.new(0.5, -100, 0.5, -120)
    weaponFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    weaponFrame.Parent = weaponGui

    local title = Instance.new("TextLabel", weaponFrame)
    title.Size = UDim2.new(1, 0, 0, 40)
    title.Text = "무기 선택"
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 18
    title.TextColor3 = Color3.new(1, 1, 1)
    title.BackgroundColor3 = Color3.fromRGB(70, 130, 180)

    local function createWeaponButton(weapon, position)
        local button = Instance.new("TextButton", weaponFrame)
        button.Size = UDim2.new(1, -20, 0, 40)
        button.Position = UDim2.new(0, 10, 0, position)
        button.Text = weapon
        button.Font = Enum.Font.SourceSansBold
        button.TextSize = 18
        button.TextColor3 = Color3.new(1, 1, 1)
        button.BackgroundColor3 = Color3.fromRGB(70, 130, 180)

        button.MouseButton1Click:Connect(function()
            selectedWeapon = weapon
            weaponButton.Text = "무기 선택: " .. selectedWeapon
            weaponGui:Destroy()
        end)
    end

    for i, weapon in ipairs(weapons) do
        createWeaponButton(weapon, 40 + (i - 1) * 50)
    end
end)

-- 수동 드래그 구현
local dragging, startMouse, startPos = false, nil, nil

frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        startMouse = input.Position
        startPos = frame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

UIS.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - startMouse
        frame.Position = UDim2.new(
            startPos.X.Scale, startPos.X.Offset + delta.X,
            startPos.Y.Scale, startPos.Y.Offset + delta.Y
        )
    end
end)

-- K키로 GUI 보이기/숨기기
UIS.InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == Enum.KeyCode.K then
        frame.Visible = not frame.Visible
    end
end)
