-- 전체 코드 (로컬 UI + 서버 데이터 저장/롤백 처리)

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- 1. UI 코드: 화면에 버튼 표시
local screenGui = Instance.new("ScreenGui")
screenGui.Parent = playerGui

local saveButton = Instance.new("TextButton")
saveButton.Size = UDim2.new(0, 200, 0, 50)
saveButton.Position = UDim2.new(0.5, -100, 0.5, -25) -- 화면 가운데 배치
saveButton.Text = "데이터 저장"
saveButton.Parent = screenGui

-- 2. 데이터 저장과 롤백을 위한 변수 설정
local playerInventories = {}
local canSaveData = {}  -- 저장을 허용할 플레이어를 추적

-- 3. SaveButton 이벤트 (버튼 클릭 시 서버로 데이터 저장 요청)
saveButton.MouseButton1Click:Connect(function()
    -- 서버로 SaveButton 리모트 이벤트 호출
    local saveButtonEvent = ReplicatedStorage:WaitForChild("SaveButton")
    saveButtonEvent:FireServer()
end)

-- 4. 데이터 저장 함수 (플레이어의 인벤토리 저장)
function savePlayerData(player)
    if not canSaveData[player.UserId] then
        -- 데이터 저장 불가 상태
        print(player.Name .. "는 저장할 수 없습니다. 버튼을 눌러야 합니다.")
        return
    end

    -- 현재 플레이어의 데이터를 저장
    local inventory = getPlayerInventory(player)
    playerInventories[player.UserId] = inventory
    print(player.Name .. "의 데이터가 저장되었습니다.")
end

-- 5. 플레이어 인벤토리 가져오기 (예시로 '검' 포함)
function getPlayerInventory(player)
    return playerInventories[player.UserId] or {"검"}  -- 기본적으로 '검'을 갖고 있음
end

-- 6. 인벤토리 설정하기
function setPlayerInventory(player, inventory)
    playerInventories[player.UserId] = inventory
end

-- 7. 리모트 이벤트 자동 생성 (ReplicatedStorage에 SaveButton)
local saveButtonEvent = Instance.new("RemoteEvent")
saveButtonEvent.Name = "SaveButton"
saveButtonEvent.Parent = ReplicatedStorage

-- 8. 리모트 이벤트 처리 (UI에서 서버로 전송되는 데이터 저장 요청)
saveButtonEvent.OnServerEvent:Connect(function(player)
    canSaveData[player.UserId] = true  -- 저장 허용
    savePlayerData(player)  -- 데이터 저장
end)

-- 9. 리조인 시 데이터를 롤백
Players.PlayerAdded:Connect(function(player)
    -- 리조인 시 저장된 데이터가 있다면 복원
    local savedData = playerInventories[player.UserId]
    if savedData then
        -- 저장된 데이터로 복원
        setPlayerInventory(player, savedData)
        print(player.Name .. " 리조인: 데이터 롤백됨")
    else
        -- 초기화 상태
        setPlayerInventory(player, {"검"})
        print(player.Name .. " 초기화됨 (검 추가됨)")
    end
end)
