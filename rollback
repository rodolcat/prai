local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

-- 롤백 데이터 저장 변수
local rollbackData = nil

-- UI 생성
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "RollbackUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true
ScreenGui.Parent = game:GetService("CoreGui")

-- 버튼 생성 함수
local function createButton(name, position, text, callback)
    local button = Instance.new("TextButton")
    button.Name = name
    button.Size = UDim2.new(0, 200, 0, 50)
    button.Position = position
    button.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.Font = Enum.Font.SourceSans
    button.TextSize = 24
    button.Text = text
    button.Parent = ScreenGui
    button.MouseButton1Click:Connect(callback)
end

-- Rollback 버튼 기능
createButton("RollbackButton", UDim2.new(0, 100, 0, 100), "Rollback", function()
    rollbackData = {
        inventory = {},
        position = Character.HumanoidRootPart.Position,
        health = Character.Humanoid.Health
    }

    -- 인벤토리 상태 저장
    for _, item in pairs(LocalPlayer.Backpack:GetChildren()) do
        table.insert(rollbackData.inventory, item.Name)
    end
    print("Rollback point saved.")
end)

-- Rejoin 버튼 기능
createButton("RejoinButton", UDim2.new(0, 100, 0, 160), "Rejoin", function()
    if rollbackData then
        -- 인벤토리 복원
        for _, item in pairs(LocalPlayer.Backpack:GetChildren()) do
            item:Destroy()
        end
        for _, itemName in ipairs(rollbackData.inventory) do
            local newTool = Instance.new("Tool")
            newTool.Name = itemName
            newTool.Parent = LocalPlayer.Backpack
        end

        -- 위치 및 체력 복원
        Character:SetPrimaryPartCFrame(CFrame.new(rollbackData.position))
        Character.Humanoid.Health = rollbackData.health

        -- 서버 재접속
        TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId, LocalPlayer)

        print("Rollback complete and rejoined to server.")
    else
        print("No rollback point set.")
    end
end)
